<!DOCTYPE html>
<html lang="en" xmlns:th="" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!--  link   -->
    <th:block th:insert="~{fragments/link :: linkFragment}" />


    <link rel="stylesheet" href="/css/trading/chat/room.css">

    <script src="/js/myinfo/confirm.js" defer> </script>

    <script th:inline="javascript">
        let  wspath = /*[[${wspath}]]*/
        let  username = /*[[${username}]]*/
        let  users = /*[[${users}]]*/
        console.log(users);
    </script>
</head>
<body>

<div class="wrapper">

    <!-- header   -->
    <th:block th:insert="~{fragments/header :: mainHeaderFragment}" />

    <!-- nav       -->
    <th:block th:insert="~{fragments/nav :: navFragment}" />

    <main class="room-block layout-5">
        <section>
            <div class="left">
                <div class="image-block">
                    <img  th:src="@{${tradingImage.fileid.dir}+'\s_'+${tradingImage.fileid.filename}}"  alt="" />

                </div>
                <div class="title">
                    <span>TITLE</span>
                </div>
                <div class="start-price">
                    <span>제작자 : </span><span th:text="${tradingImage.fileid.images.username}"></span>
                </div>
                <div class="start-price">
                    <span>시작가 : </span><span></span>
                </div>
                <div class="start-price">
                    <span>낙찰가 : </span><span ></span>
                </div>
                <div class="status">
                    <span>상태 : </span><span></span>
                </div>
            </div>
            <div class="center">
                <div class="status">
                    <div class="now-price">
                        <div>
                            <span>시작가 : </span> <span>1000 </span><span> 원</span>
                        </div>
                        <div>
                            <span>낙찰가 : </span><span>1000</span><span> 원</span>
                        </div>
                        <div>
                            <span>유저 : </span><span>user@example.com</span>
                        </div>
                    </div>
                </div>
                <div class="show-item">
                    <div class="chat">
                    </div>
                </div>
                <div class="user-call">
                    <div class="top">
                        <div class="control">
                            <a href="javascript:void(0)" class=" ">관리자호출</a>
                            <a href="javascript:quit()" class=" ">나가기</a>
                        </div>
                        <div style="display:flex;justify-content:center;">
                            <input class="form-control w-50 m-2 content" placeholder="가격입력">
                            <button onclick="sendMsg()" class="m-2 btn btn-primary">가격부르기</button>
                        </div>
                    </div>
                    <hr>
                    <div class="body">
                        <a href="" class="btn btn-primary m-1">+1000</a>
                        <a href="" class="btn btn-primary m-1">+3000</a>
                        <a href="" class="btn btn-primary m-1">+5000</a>
                        <a href="" class="btn btn-primary m-1">+10000</a>
                    </div>
                </div>

            </div>

            <div class="right">
                <div>총 : <span class="cur">0</span>/<span>5</span> <span style="font-size : .7rem;">(관리자계정은제외)</span></div>
                <div class="user-block">

<!--                    <div class="user">-->
<!--                        <div class="profile-image">-->
<!--                            <img src="anon.jpg" alt="">-->
<!--                        </div>-->
<!--                        <div class="username">user@naver.com</div>-->
<!--                        <div class="accept">-->
<!--                            <a href="">낙찰</a>-->
<!--                        </div>-->
<!--                        <div class="control-1">-->
<!--                            <div><a href="">1:1</a></div>-->
<!--                        </div>-->
<!--                        <div class="control-2">-->
<!--                            <div><a href="">강퇴</a></div>-->
<!--                        </div>-->
<!--                    </div>-->

                </div>

            </div>
        </section>


        <div th:text="${tradingImage}"></div>
    </main>





    <!-- Footer        -->
    <footer>
        <th:block th:insert="~{fragments/footer :: footerFragment}" />
    </footer>



    <script th:inline="javascript">

        let total=0;
        let userlist = [];
        const curEl =document.querySelector('.cur');
        curEl.innerHTML = total;
        function enterRoom(socket){
            var enterMsg={"type" : "ENTER","roomId":[[${room.roomId}]],"sender":[[${username}]],"msg":""}; //sender는  글쓸때 수정하자.
            socket.send(JSON.stringify(enterMsg));
        }

        //연결시도를 바로하지말고 기존에 세션이 있으면 그걸 사용
        let socket = new WebSocket(`${wspath}`);

        socket.onopen = function (e) {
            console.log('open server!')
            enterRoom(socket);
        };
        socket.onclose=function(e){
            console.log('disconnet');
        }

        socket.onerror = function (e){
            console.log(e);
        }

        //메세지 수신했을 때 이벤트.
        socket.onmessage = function(e){
           console.log(e.data);
           console.log(typeof e.data);
           var obj = JSON.parse(e.data);

            let msgArea = document.querySelector('.chat');
            let newMsg = document.createElement('div');
           if(obj.type=='ENTER'){
                newMsg.innerText="--- "  + obj.msg + " ----";
                newMsg.setAttribute("style","text-align:center;color:gray;font-size:.8rem;margin:3px;");

                   //기존 접속 제거
                   var AllUserBlock = document.querySelectorAll('.user-item');
                   AllUserBlock.forEach(el=>{
                    el.remove();
                   });

                  if(obj.sender!=username){
                      if(!users.includes(obj.sender))
                        users.push(obj.sender);
                  }

                   curEl.innerHTML=users.length;
                   //접속 유저 추가
                   users.forEach(user=>{
                    createUserItem(user);
                   });




           }
           else if(obj.type=='TALK'){
                if(username==obj.sender){
                    newMsg.innerText= obj.msg;
                    newMsg.setAttribute("style","text-align:right;color:black;font-size:1rem;margin:5px;");
                }else{
                    newMsg.innerText= "[ "+ obj.sender +" ] : "+obj.msg;
                    newMsg.setAttribute("style","text-align:left;color:black;font-size:1rem;margin:5px;");
                }

           }else if(obj.type=='QUIT'){
                newMsg.innerText="--- "  + obj.msg + " ----";
                newMsg.setAttribute("style","text-align:center;color:gray;font-size:.8rem;margin:5px;");


                   //기존 접속 제거
                   var AllUserBlock = document.querySelectorAll('.user-item');
                   AllUserBlock.forEach(el=>{
                    el.remove();
                   });



                   users = users.filter(user=>user!=obj.sender);

                   curEl.innerHTML=users.length;
                   //접속 유저 추가
                   users.forEach(user=>{
                    createUserItem(user);
                   });
           }


            msgArea.append(newMsg);

            msgArea.scrollIntoView(false);
        }

        //메세지 보내기 버튼 눌렀을 떄..
        function sendMsg() {
            let content=document.querySelector('.content').value;
             var talkMsg={"type" : "TALK","roomId":[[${room.roomId}]] ,"sender":[[${username}]],"msg":content};
           socket.send(JSON.stringify(talkMsg));
           content.value='';
        }
        let content=document.querySelector('.content');
        content.addEventListener('keydown',function(e){
            console.log(e.keyCode);
            if(e.keyCode==13){
                sendMsg()
                content.value='';
            }
        });


        function quit(){
             var quitMsg={"type" : "QUIT","roomId":[[${room.roomId}]] ,"sender":[[${username}]],"msg":"연결을 종료합니다."};
            socket.send(JSON.stringify(quitMsg));
            socket.close();
            location.href="/trading/image/main";
        }


        function createUserItem(user){
                // 프로필 요소를 선택

                var userBlock = document.querySelector('.user-block');

                var profile = document.createElement('div');
                profile.classList.add('user-item');
                profile.classList.add(user);

                // 프로필 정보 설정
                var profileImageSrc = '/assets/anon.jpg';
                var usernameText = user;

                // 프로필 이미지 생성
                var profileImage = document.createElement('div');
                profileImage.classList.add('profile-image');
                profileImage.innerHTML = '<img src="' + profileImageSrc + '" alt="">';
                profile.appendChild(profileImage);

                // 사용자명 생성
                var username = document.createElement('div');
                username.classList.add('username');
                username.textContent = usernameText;
                profile.appendChild(username);

                // '낙찰' 링크 생성
                var acceptLink = document.createElement('div');
                acceptLink.classList.add('accept');
                acceptLink.innerHTML = '<a href="">낙찰</a>';
                profile.appendChild(acceptLink);

                // '1:1' 링크 생성
                var control1Link = document.createElement('div');
                control1Link.classList.add('control-1');
                control1Link.innerHTML = '<div><a href="">1:1</a></div>';
                profile.appendChild(control1Link);

                // '강퇴' 링크 생성
                var control2Link = document.createElement('div');
                control2Link.classList.add('control-2');
                control2Link.innerHTML = '<div><a href="">강퇴</a></div>';
                profile.appendChild(control2Link);


                userBlock.appendChild(profile);
        }

         function removeUserItem(obj){
            var userBlock = document.querySelector('.user-block');
            userBlock.querySelector(`.${obj.sender}`).remove();
         }

    </script>
</div>




</body>
</html>